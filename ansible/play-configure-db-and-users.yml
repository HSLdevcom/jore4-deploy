---
- name: Retrieve bastion host IP address for {{ az_environment }}
  hosts: localhost
  roles:
    - role: fetch_ip_address
      resource_group: "{{ az_resource_group_name }}"
      pip_name: "{{ az_resource_group_name }}-bastion-pip"
      output_name: bastion_ip

- name: Retrieve db admin credentials from keyvault for {{ az_environment }}
  hosts: localhost
  roles:
    - fetch_db_admin_credentials

- name: "Create db credentials for hasura in key-vault for {{ az_environment }}"
  hosts: localhost
  roles:
    - role: create_user_credentials
      username: "dbhasura{{ az_environment }}"
      keyvault_name: "{{ az_resource_group_name }}-vault"
      username_secret_name: "{{ az_resource_group_name }}-hasura-username"
      password_secret_name: "{{ az_resource_group_name }}-hasura-password"
      username_output_name: "hasura_username"
      password_output_name: "hasura_password"

- name: "Create db credentials for jore3 importer in key-vault for {{ az_environment }}"
  hosts: localhost
  roles:
    - role: create_user_credentials
      username: "dbjore3importer{{ az_environment }}"
      keyvault_name: "{{ az_resource_group_name }}-vault"
      username_secret_name: "{{ az_resource_group_name }}-jore3importer-username"
      password_secret_name: "{{ az_resource_group_name }}-jore3importer-password"
      username_output_name: "jore3importer_username"
      password_output_name: "jore3importer_password"

- name: "Create keyvault secret with the name for the database for {{ az_environment }}"
  hosts: localhost
  roles:
    - role: create_keyvault_secret
      keyvault_name: "{{ az_resource_group_name }}-vault"
      secret_name: "{{ az_resource_group_name }}-db-database"
      secret_value: "jore4{{ az_environment }}"
      output_name: "database_name"

- name: "Create temporary tunnel to bastion host for {{ az_environment }}"
  hosts: localhost
  roles:
    - role: create_ssh_tunnel
      bastion_host_hostname: "{{ bastion_ip }}"
      bastion_host_user: hsladmin
      identity_file_path: /home/ansible/jore4_key_ed25519
      remote_hostname: "{{ db_hostname }}"
      remote_port: 5432
      local_port: 1234
      keep_alive_seconds: 60

- name: "Create database and credentials in PostgreSQL for {{ az_environment }}"
  hosts: localhost
  roles:
    - role: execute_psql_file
      db_hostname: localhost
      db_port: 1234
      db_database: postgres
      db_username: "{{ db_admin_username }}"
      db_password: "{{ db_admin_password }}"
      sql_file: "./files/create-db-and-users.sql"
      psql_extra_params:
        - "-v database_name='{{ database_name }}'"
        - "-v hasura_username='{{ hasura_username }}'"
        - "-v hasura_password='{{ hasura_password }}'"
        - "-v jore3importer_username='{{ jore3importer_username }}'"
        - "-v jore3importer_password='{{ jore3importer_password }}'"
